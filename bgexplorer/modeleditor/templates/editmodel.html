{# do not load headers, etc if this is an ajax request #}
{% if not request.is_xhr %}

    {% extends "bootstrap/base.html" %}

    {% block title %}Edit Model{% endblock %}

    {% block styles %}
	{{ super() }}
	<style>
	 h1 {margin-top:0px}
	 /*body, .btn, .form-control, .glyphicon {font-size:small;}*/
	 .linklike {cursor:pointer; }
	 .Assembly td:first-child:after {content:"â†´"; padding-left:0.15em; color:green;}
	 #componentsdiv td[data-column=weight] {display:none}
	 #editor td[data-column=description] {display:none}
	 td[data-column=weight] input {width:3em;}
	 .form-inline, .form-inline div.input-group {display:inline-block}
	</style>
    {% endblock %}

    {% block scripts %}
	{{ super() }}
	<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js" ></script>
	<script type="text/javascript" >
	 //$("#assemblytable tbody tr.component, #unplacedtable tbody tr.component").draggable({'helper':'clone'});
	 //$("#assemblytable tbody").sortable({'helper':"clone", 'placeholder':'warning', 'containment':});
	 
	 //necessary script for sortable table widget
	 $("tbody.sortable").sortable({
	     'placeholder':'warning',
	     'update':function(event, ui){sortIndices(event.target);},
	 });
	 //prevent buttons from looking still depressed
	 $(".btn").mouseup(function(){
	     $(this).blur();
	 });
	 function newsubcomp(cls, source){
	     cls = cls || "Component";
	     var clonerow = $("#copycomptable tr").clone(true);
	     if(source){
		 clonerow.data('rawobj') = source;
		 cls = source.cls || cls;
	     }
	     clonerow.addClass(cls);
	     clonerow.data('rawobj')['__class__'] = cls;
	     $("#editingsubcomps tbody").append(clonerow);
	 }

	 function updatesubcomp(input){ //update the data-rawobj attribute for a subcomponent row
	     var val = input.val();
	     if(input.attr("name") == "weight")
		 val = Number(val);
	     input.parents("tr").data('rawobj')[input.attr('name')] = val;
	 }
	 
	 function updateallsubcomps(){ 
	     var subcomps = $("#editingsubcomps tbody tr.component").map(function(){ return $(this).data('rawobj'); });
	     $("#components").val(JSON.stringify(subcomps.get()));
	     
	 }

	 function placecomponent(node){
	     var newnode = $(node).clone(true);
	     newnode.data('rawobj')['weight'] = 1;
	     newnode.find("input[name=weight]").val(1);
	     newnode.appendTo("#editingsubcomps tbody");
	 }

	 function filtercomponents(){
	     var filtertext = $("#filtercomponents").val();
	     var allrows = $("#componentsdiv tr.component, #specsdiv tr.spec");
	     if(filtertext.length < 2){
		 allrows.show();
		 return allrows;
	     }
	     var regex = new RegExp(filtertext);
	     allrows.hide();
	     allrows.filter(function(){
		 var rawobj = $(this).data('rawobj') || {};
		 var mytext = $(this).children("td").text() + " "+
			      Object.keys(rawobj).map(key => rawobj[key]).join(" ");
		 return regex.test(mytext);
		 
	     }).show();
	     return allrows;
	 }

	 //trigger a post action from a link
	 //args are additional non-url arguments
	 function dopost(event){
	     event.preventDefault();
	     var target = $(event.target);
	     var cfmessage = target.data("confirm");
	     if(!cfmessage || confirm(cfmessage)){
		 var form = $("<form method='POST' action='"+target.attr("href")+"'>");
		 var args = target.data('form');
		 if(args){
		     for(var key in args){
			 $("<input>").attr("name",key).val(args[key]).appendTo(form);
		     }
		 }
		 form.appendTo("body").submit();
		 
	     }
	 }
	 
	</script>
    {% endblock %}
{% endif %}

{% import "bootstrap/wtf.html" as wtf %}

{% macro printcompfield(name, value="") %}
    <input type="text" class="form-control" name="{{ name }}" value="{{ value or ''}}" 
	   {% if name=='name' %} placeholder="<new component>"{% endif %}
	   oninput="updatesubcomp($(this));">
{% endmacro %}

{% macro printplacement(placement="NEW", level=0, editable=false) %}
    {% if placement == "NEW" %}
	{% set comp={'id':none, 'name':'<NEW>'} %}
	{% set dataraw={'weight':1, 'querymod':none} %}
    {% elif placement.component is defined %}
	{% set comp=placement.component %}
	{% set dataraw={'component':comp.id, 'weight': placement.weight, 'querymod': placement.querymod} %}
    {% else %}
	{% set comp=placement %}
	{% set dataraw={'component':comp.id} %}
    {% endif %}

    <tr class="linklike component {% if editcomponent is defined and comp.id == editcomponent.id -%} info {%- endif -%}
	       {%- if comp.getcomponents is defined %} Assembly {% endif -%} " 
	data-id="{{ comp.id }}" data-rawobj='{{ dataraw | tojson }}' 
        onclick="window.location='{{ url_for('.editcomponent',modelid=model.id, componentid=comp.id) }}'" >
	{% if editable and not comp.id %}
	<td data-column="name" >{{ printcompfield('name', dataraw.get('name')) }}</td>
	{% else %}
	<td data-column="name" style="padding-left:{{ 15*level }}px" >{{ comp.name }}</td>
	{% endif %}
	<td data-column="description">{{ comp.description or "" }}</td>
	<td data-column="weight" > {{ printcompfield('weight', dataraw.get('weight',1)) }} </td>
    </tr>
{% endmacro %}

{% macro componenttable(components, recursive=true, id="") %}
    <table class="table table-condensed table-hover comptable" id="{{ id }}">
	<thead>
	    {% if recursive %}
	    <tr><th>Name</th><th>Description</th></tr>
	    {% else %}
	    <tr><th>Name</th><th>Quantity</th></tr>
	    {% endif %}
	</thead>
	<tbody>
	    {% for comp in components recursive %}
		{% if comp == model.assemblyroot %}
		    <tr><th colspan="2" style="background-color:#fafafa;" > Assembly Tree</th></tr>
		{% endif %}
		{{ printplacement(comp, loop.depth0, editable=not recursive) }}
		{% if recursive %}
		    {% if comp.components is defined %}
			{{ loop(comp.components) }}
		    {% elif comp.component is defined and comp.component.components is defined %}
			{{ loop(comp.component.components) }}
		    {% endif %}
		{% endif %}
		{% if comp == model.assemblyroot %}
		    <tr><th colspan="2" style="background-color:#fafafa;" > Unplaced components</th></tr>
		{% endif %}
	    {% endfor %}
	    
	</tbody>
    </table>
{% endmacro %}


{% macro printspec(spec) %}
    <tr class="linklike spec {% if editspec is defined and spec.id == editspec.id -%} info {%- endif -%}"
        onclick="window.location='{{ url_for('.editspec',modelid=model.id, specid=spec.id) }}';" >
	<td data-column="name" >{{ spec.name }}</td>
	<td data-column="category" >{{ spec.category }}</td>
	<td data-column="distribution" >{{ spec.distribution }}</td>
	<td data-column="rate" >{{ spec.getratestr(2) }}</td>	
    </tr>
{% endmacro %}

{% macro spectable(specs, id="") %}
    <table class="table table-condensed table-hover spectable table-responsive" id="{{ id }}">
	<thead>
	    <tr><th>Name</th><th>Category</th><th>Dist.</th><th>Rate</th></tr>
	</thead>
	<tbody>
	    {% for spec in specs %}
		{{ printspec(spec) }}
	    {% endfor %}
	</tbody>
    </table>
{% endmacro %}



{% block content %}
    <div class="container" id="" >
	<div class="page-header"> 
	    <div class="row" >
		<div class="col-sm-4"> 
		    <h1>Editing Model: <small>{{ model.name }} v{{ model.version }}
		    </small></h1>
		    <small>{{ model.description }}</small>
		</div>
		<div class="col-sm-3" >
		    <button class="btn btn-success">Save New Version</button> 
		    <button class="btn btn-danger btn-sm">Discard Changes</button>
		</div>
		<div class="col-sm-5" >
		    <div id="message">
			{% for cat,msg in get_flashed_messages(with_categories=true) %}
			    <div class="alert alert-{{ cat }} alert-dismissable" >
				{{ msg }}
				<a href="#"  class="close" data-dismiss="alert" >
				    &times;
				</a>
			    </div>
			{% endfor %}
		    </div>
		</div>
	    </div>
	    
	</div>
    

	<div class="row" >
	    <div class="col-sm-6">
		
		<ul class="nav nav-tabs" >
		    <li {%- if editspec is not defined %} class="active" {% endif -%}>
			<a data-toggle="tab" href="#componentsdiv">Components</a>
		    </li>
		    <li {%- if editspec is defined %} class="active" {% endif -%}>
			<a data-toggle="tab" href="#specsdiv">Specifications</a>
		    </li>
		    <li>
			<div class="input-group pull-right" >
			    <input type="text" class="form-control" id="filtercomponents" placeholder="Search" 
				   oninput="filtercomponents()" size="30" >
			    <div class="input-group-btn">
				<button class="btn btn-default" 
					onclick="$('#filtercomponents').val('');filtercomponents()" >
				    <span class="glyphicon glyphicon-remove" ></span>
				</button>
			    </div>
			</div>
		    </li>
		</ul>
		
		<div class="tab-content" >
		    
		    <div id="componentsdiv" class="tab-pane fade {% if editspec is not defined %}in active{% endif %}" >
			<h2>Components <small>
			    <form action="{{ url_for('.newcomponent',modelid=model.id) }}" 
				  method="POST" class="pull-right form-inline" >
				<label>Create new:</label>
				<span class="btn-group" >
				    <button type="submit" class="btn btn-default btn-sm" name="class" value="Component" >
					Component
				    </button>
				    <button type="submit" class="btn btn-default btn-sm" name="class" value="Assembly" >
					Assembly
				    </button>
				</span>
			    </form></small>
			</h2>
		
			
			{{  componenttable([model.assemblyroot] + model.get_unplaced_components(), true, "assemblytable") }}
			{# <h3>Unplaced Components </h3>
			{{ componenttable(model.get_unplaced_components(), true, "unplacedtable") }}#}
			
		    </div> {# close components div #}

	    
		    <div id="specsdiv" class="tab-pane fade {% if editspec is defined %}in active{% endif %}" >
			<h2>Specifications <small>
			    <form class="form-inline pull-right" action="{{ url_for('.newspec',modelid=model.id) }}" 
				  method="POST">
				<div class="form-group push-right" >
				    <label for="newspec">Create new: </label>
				    <select class="form-control" id="newspec" name="type" 
					    onchange="$(this).parents('form').submit();" >
					<option style="color:gray;font-style:italic"> Select a spec type</option>
					{% for spectype in spectypes %}
					    <option value="{{ spectype }}">{{ spectype }}</option>
					{% endfor %}
				    </select>
				</div>
			    </form>
			</small></h2>
			{{ spectable(model.specs.values()) }}
		    </div> {# close specsdiv #}
		</div> {# close tab-content  #}
	    </div> {# close col-sm-6 #}
	    
	    <div class="col-sm-6" >
		<div id="editor"  >
		    {% if form is defined %}
			{% if editcomponent is defined %}
			    {% include "editcomponent.html" %}
			{% elif editspec is defined %}
			    {% include "editspec.html" %}
			{% endif %}
		    {% endif %}
		</div>
	    </div>
	</div>
	<div class="row clearfix" style="padding-top:10em;" ></div>
    </div>
{% endblock %}
